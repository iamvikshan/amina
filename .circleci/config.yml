# CircleCI Configuration for Amina Discord Bot
# Uses Doppler CLI for secrets management
# Free tier: 30,000 credits/month (~6,000 build minutes)

version: 2.1

# ============================================
# Orbs - Reusable packages
# ============================================
orbs:
  docker: circleci/docker@2.6.0

# ============================================
# Commands - Reusable step sequences
# ============================================
commands:
  setup-bun:
    description: "Install Bun and dependencies"
    steps:
      - run:
          name: Install Bun
          command: |
            curl -fsSL https://bun.sh/install | bash
            echo 'export BUN_INSTALL="$HOME/.bun"' >> "$BASH_ENV"
            echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> "$BASH_ENV"
      - run:
          name: Verify Bun installation
          command: bun --version
      - restore_cache:
          keys:
            - bun-deps-v1-{{ checksum "bun.lock" }}
            - bun-deps-v1-
      - run:
          name: Install dependencies
          command: bun install --frozen-lockfile
      - save_cache:
          key: bun-deps-v1-{{ checksum "bun.lock" }}
          paths:
            - node_modules
            - ~/.bun/install/cache

  setup-doppler:
    description: "Install Doppler CLI"
    steps:
      - run:
          name: Install Doppler CLI
          command: |
            curl -sLf --retry 3 --tlsv1.2 --proto "=https" \
              'https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key' | \
              sudo gpg --dearmor -o /usr/share/keyrings/doppler-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main" | \
              sudo tee /etc/apt/sources.list.d/doppler-cli.list
            sudo apt-get update && sudo apt-get install -y doppler

# ============================================
# Jobs
# ============================================
jobs:
  # TypeScript & ESLint check
  lint-typecheck:
    docker:
      - image: cimg/base:current
    resource_class: small
    steps:
      - checkout
      - setup-bun
      - run:
          name: TypeScript & ESLint Check
          command: bun run check

  # Prettier format check
  lint-format:
    docker:
      - image: cimg/base:current
    resource_class: small
    steps:
      - checkout
      - setup-bun
      - run:
          name: Prettier Format Check
          command: bun run f:check

  # Docker build and health check
  docker-test:
    docker:
      - image: cimg/base:current
    resource_class: medium
    steps:
      - checkout
      - setup_remote_docker:
          version: default
          docker_layer_caching: true
      - setup-doppler
      - run:
          name: Build Docker Image
          command: docker build -t amina:test .
      - run:
          name: Prepare Test Environment
          command: |
            if [ -n "$DOPPLER_TOKEN" ]; then
              doppler secrets download -p amina -c dev --no-file --format env > .env.test
              echo "Doppler secrets loaded from amina/dev"
            else
              echo "DOPPLER_TOKEN not set, using minimal test env"
              echo "NODE_ENV=test" > .env.test
              echo "HEALTH_PORT=3000" >> .env.test
            fi
      - run:
          name: Run Container Health Check
          command: |
            # Start container
            docker run -d --name amina-test --env-file .env.test -p 3000:3000 amina:test

            # Wait for health
            echo "Waiting for container to be healthy..."
            for i in $(seq 1 30); do
              if docker exec amina-test wget --no-verbose --tries=1 --spider http://localhost:3000/health 2>/dev/null; then
                echo "Container is healthy!"
                docker stop amina-test
                docker rm amina-test
                exit 0
              fi
              echo "Attempt $i/30 - waiting..."
              sleep 2
            done

            echo "Container health check failed"
            docker logs amina-test
            docker stop amina-test || true
            docker rm amina-test || true
            exit 1

# ============================================
# Workflows
# ============================================
workflows:
  # Main CI workflow
  ci:
    jobs:
      # Pre-build: Lint checks run in parallel
      - lint-typecheck
      - lint-format

      # Post-build: Docker test (only on main branch)
      - docker-test:
          requires:
            - lint-typecheck
            - lint-format
          filters:
            branches:
              only: main
