services:
  # Amina Discord Bot
  amina:
    image: vikshan/amina:latest
    container_name: amina
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Override Lavalink connection to use Docker network
      LAVALINK_HOST_1: lavalink
      LAVALINK_PORT_1: 2333
      LAVALINK_SECURE_1: "false"
      HEALTH_PORT: 3000
    networks:
      - amina-network
    ports:
      - "3000:3000"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Lavalink Music Server
  lavalink:
    image: ghcr.io/lavalink-devs/lavalink:latest
    container_name: lavalink
    restart: unless-stopped
    # Run as root initially to fix permissions, then switch to lavalink user in entrypoint
    user: root
    env_file:
      - .env
    environment:
      - _JAVA_OPTIONS=-Xmx512M -Xms256M
      - SERVER_PORT=2333
      - LAVALINK_SERVER_PASSWORD=${LAVALINK_PASSWORD_1:-incorrect}
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    volumes:
      - ./lavalink/application.yml:/opt/Lavalink/application.yml:ro
      - lavalink-plugins:/opt/Lavalink/plugins
      # Mount entrypoint script to fix permissions (similar to how Amina handles logs)
      - ./lavalink-entrypoint.sh:/lavalink-entrypoint.sh:ro
    entrypoint: ["/bin/sh", "/lavalink-entrypoint.sh"]
    networks:
      - amina-network
    ports:
      - "2333:2333"
    healthcheck:
      test: [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider --header='Authorization:
          ${LAVALINK_PASSWORD_1:-incorrect}' http://localhost:2333/version ||
          exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Uptime Kuma Monitoring
  uptime-kuma:
    image: louislam/uptime-kuma:nightly2
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime-kuma-data:/app/data
    networks:
      - amina-network
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD-SHELL", "node extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Watchtower - Automatic container updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - .env
    environment:
      # Update behavior
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_ROLLING_RESTART=true
      # Discord notifications (uses LOGS_WEBHOOK from .env)
      - WATCHTOWER_NOTIFICATION_URL=${LOGS_WEBHOOK}
    networks:
      - amina-network

networks:
  amina-network:
    driver: bridge

volumes:
  uptime-kuma-data:
    driver: local
  lavalink-plugins:
    driver: local
