services:
  # Amina Discord Bot
  amina:
    image: vikshan/amina:latest
    container_name: amina
    restart: unless-stopped
    depends_on:
      lavalink:
        condition: service_healthy
    env_file:
      - .env
    environment:
      # Override Lavalink connection to use Docker network
      LAVALINK_1_HOST: lavalink
      LAVALINK_1_PORT: 2333
      HEALTH_PORT: 3000
    networks:
      - amina-network
    # Ports accessed via Cloudflare Tunnel (no direct exposure)
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Lavalink Music Server
  lavalink:
    image: ghcr.io/lavalink-devs/lavalink:latest
    container_name: lavalink
    restart: unless-stopped
    # Run as root initially to fix permissions, then switch to lavalink user in entrypoint
    user: root
    env_file:
      - .env
    environment:
      - _JAVA_OPTIONS=-Xmx512M -Xms256M
      - SERVER_PORT=2333
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    volumes:
      - ./lavalink/application.yml:/opt/Lavalink/application.yml:ro
      - lavalink-plugins:/opt/Lavalink/plugins
    # Fix plugin directory permissions then switch to lavalink user
    # Runs as root only for chown/chmod, then re-execs as lavalink so
    # Java is PID 1 and receives signals (SIGTERM, SIGINT) properly.
    entrypoint:
      - /bin/sh
      - -c
      - |
        if [ -d /opt/Lavalink/plugins ]; then
          chown -R lavalink:lavalink /opt/Lavalink/plugins
          chmod -R 755 /opt/Lavalink/plugins
        fi
        cd /opt/Lavalink
        exec setpriv --reuid=lavalink --regid=lavalink --init-groups /opt/java/openjdk/bin/java -jar Lavalink.jar
    networks:
      - amina-network
    # Ports accessed via Cloudflare Tunnel (no direct exposure)
    healthcheck:
      test: [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider --header='Authorization:
          ${LAVALINK_PASS:-thoushantpass}' http://localhost:2333/version ||
          exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Cloudflare Tunnel - Secure access without exposing public IP
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    env_file:
      - .env
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL}
      - TUNNEL_METRICS=0.0.0.0:2000
    networks:
      - amina-network
    healthcheck:
      test:
        ["CMD", "cloudflared", "tunnel", "--metrics", "0.0.0.0:2000", "ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Watchtower - Automatic container updates
  watchtower:
    image: nickfedor/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - .env
    environment:
      # Update behavior
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_ROLLING_RESTART=true
      # Discord notifications (uses LOGS_WEBHOOK from .env)
      - WATCHTOWER_NOTIFICATION_URL=${LOGS_WEBHOOK}
    networks:
      - amina-network

networks:
  amina-network:
    driver: bridge

volumes:
  lavalink-plugins:
    driver: local
