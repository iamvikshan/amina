---
/**
 * Amina's Tactical Sidebar
 * A reusable sidebar component for dashboard navigation
 * Inspired by Amina's character: Protective, organized, and tactical
 */

import SidebarIcon from './SidebarIcon.astro';

export interface SidebarSection {
  title: string;
  icon?: string;
  items: SidebarItem[];
}

export interface SidebarItem {
  label: string;
  href?: string;
  icon?: string;
  badge?: string | number;
  badgeVariant?: 'info' | 'success' | 'warning' | 'danger';
  active?: boolean;
  onClick?: string; // Alpine.js onclick handler
  disabled?: boolean;
}

interface Props {
  sections: SidebarSection[];
  header?: {
    title: string;
    subtitle?: string;
    icon?: string;
    image?: string;
    backHref?: string;
  };
  footer?: {
    items: SidebarItem[];
  };
  collapsible?: boolean;
  defaultCollapsed?: boolean;
  class?: string;
}

const {
  sections,
  header,
  footer,
  collapsible = true,
  defaultCollapsed = false,
  class: className = '',
} = Astro.props;
---

<aside
  x-data={`{ 
    collapsed: ${defaultCollapsed},
    toggle() { this.collapsed = !this.collapsed }
  }`}
  x-bind:class="collapsed ? 'w-20' : 'w-72'"
  class={`sidebar-amina flex flex-col transition-all duration-300 ${className}`}
>
  <!-- Collapse Toggle (Mobile & Desktop) -->
  {
    collapsible && (
      <button
        x-on:click='toggle'
        x-bind:class="collapsed ? 'right-2' : '-right-3'"
        class='absolute top-20 z-50 flex h-6 w-6 items-center justify-center rounded-full border-2 border-night-steel bg-night-shadow text-cyber-blue transition-all duration-300 hover:border-cyber-blue hover:shadow-glow-blue'
        title='Toggle sidebar'
      >
        <svg
          x-show='collapsed'
          class='h-4 w-4'
          fill='none'
          stroke='currentColor'
          viewBox='0 0 24 24'
        >
          <path
            stroke-linecap='round'
            stroke-linejoin='round'
            stroke-width='2'
            d='M9 5l7 7-7 7'
          />
        </svg>
        <svg
          x-show='!collapsed'
          class='h-4 w-4'
          fill='none'
          stroke='currentColor'
          viewBox='0 0 24 24'
        >
          <path
            stroke-linecap='round'
            stroke-linejoin='round'
            stroke-width='2'
            d='M15 19l-7-7 7-7'
          />
        </svg>
      </button>
    )
  }

  <!-- Header Section -->
  {
    header && (
      <div class='sidebar-header border-b border-night-steel p-6'>
        <div class='flex items-center gap-4'>
          {/* Server Icon/Initial - TODO: enable server selection from sidebar */}
          {header.image ?
            <div class='relative h-12 w-12 flex-shrink-0 overflow-hidden rounded-lg border-2 border-amina-crimson shadow-glow-crimson'>
              <img
                src={header.image}
                alt={header.title}
                class='h-full w-full object-cover'
              />
            </div>
          : <div class='relative h-12 w-12 flex-shrink-0 flex items-center justify-center rounded-lg border-2 border-amina-crimson shadow-glow-crimson bg-night-steel'>
              <span class='text-xl font-heading font-bold text-amina-crimson'>
                {header.title?.charAt(0) || 'S'}
              </span>
            </div>
          }

          <div x-show='!collapsed' class='min-w-0 flex-1'>
            <h2 class='truncate font-heading text-lg font-bold text-white'>
              {header.title}
            </h2>
            {header.subtitle && (
              <p class='truncate text-sm text-gray-400'>{header.subtitle}</p>
            )}
          </div>
        </div>
      </div>
    )
  }

  <!-- Navigation Sections -->
  <nav class='sidebar-nav flex-1 overflow-y-auto p-4'>
    {
      sections.map((section) => (
        <div class='mb-6'>
          {section.title && (
            <h3
              x-show='!collapsed'
              class='mb-3 px-3 font-heading text-xs font-bold uppercase tracking-wider text-gray-500'
            >
              {section.title}
            </h3>
          )}

          <ul class='space-y-1'>
            {section.items.map((item) => (
              <li>
                {item.href ?
                  <a
                    href={item.href}
                    class={`sidebar-item group flex items-center gap-3 rounded-lg px-3 py-2.5 transition-all duration-200 ${
                      item.active ?
                        'bg-amina-crimson/20 text-amina-crimson shadow-glow-crimson'
                      : 'text-gray-300 hover:bg-night-steel hover:text-white'
                    } ${item.disabled ? 'cursor-not-allowed opacity-50' : ''}`}
                    title={item.label}
                    aria-disabled={item.disabled}
                  >
                    {item.icon && (
                      <span
                        class={`flex-shrink-0 ${item.active ? 'text-amina-crimson' : 'text-gray-400 group-hover:text-cyber-blue'}`}
                      >
                        <SidebarIcon name={item.icon} class='h-5 w-5' />
                      </span>
                    )}

                    <span
                      x-show='!collapsed'
                      class='flex-1 truncate font-medium'
                    >
                      {item.label}
                    </span>

                    {item.badge && (
                      <span
                        x-show='!collapsed'
                        class={`flex-shrink-0 rounded-full px-2 py-0.5 text-xs font-bold ${
                          item.badgeVariant === 'success' ?
                            'bg-discord-green/20 text-discord-green'
                          : item.badgeVariant === 'warning' ?
                            'bg-imperial-amber/20 text-imperial-amber'
                          : item.badgeVariant === 'danger' ?
                            'bg-amina-blood-red/20 text-amina-rose-red'
                          : 'bg-cyber-blue/20 text-cyber-blue'
                        }`}
                      >
                        {item.badge}
                      </span>
                    )}

                    {/* Collapsed state indicator dot for active */}
                    {item.active && (
                      <span
                        x-show='collapsed'
                        class='absolute right-2 h-1.5 w-1.5 rounded-full bg-amina-crimson'
                      />
                    )}
                  </a>
                : <button
                    type='button'
                    onclick={item.onClick}
                    class={`sidebar-item group flex w-full items-center gap-3 rounded-lg px-3 py-2.5 transition-all duration-200 ${
                      item.active ?
                        'bg-amina-crimson/20 text-amina-crimson shadow-glow-crimson'
                      : 'text-gray-300 hover:bg-night-steel hover:text-white'
                    } ${item.disabled ? 'cursor-not-allowed opacity-50' : ''}`}
                    title={item.label}
                    disabled={item.disabled}
                  >
                    {item.icon && (
                      <span
                        class={`flex-shrink-0 ${item.active ? 'text-amina-crimson' : 'text-gray-400 group-hover:text-cyber-blue'}`}
                      >
                        <SidebarIcon name={item.icon} class='h-5 w-5' />
                      </span>
                    )}

                    <span
                      x-show='!collapsed'
                      class='flex-1 truncate text-left font-medium'
                    >
                      {item.label}
                    </span>

                    {item.badge && (
                      <span
                        x-show='!collapsed'
                        class={`flex-shrink-0 rounded-full px-2 py-0.5 text-xs font-bold ${
                          item.badgeVariant === 'success' ?
                            'bg-discord-green/20 text-discord-green'
                          : item.badgeVariant === 'warning' ?
                            'bg-imperial-amber/20 text-imperial-amber'
                          : item.badgeVariant === 'danger' ?
                            'bg-amina-blood-red/20 text-amina-rose-red'
                          : 'bg-cyber-blue/20 text-cyber-blue'
                        }`}
                      >
                        {item.badge}
                      </span>
                    )}
                  </button>
                }
              </li>
            ))}
          </ul>
        </div>
      ))
    }
  </nav>

  <!-- Footer Section -->
  <div class='sidebar-footer border-t border-night-steel p-4'>
    <ul class='space-y-1'>
      {/* Back to Dashboard */}
      {
        header?.backHref && (
          <li>
            <a
              href={header.backHref}
              class='sidebar-item group flex items-center gap-3 rounded-lg px-3 py-2.5 text-gray-300 transition-all duration-200 hover:bg-night-steel hover:text-white'
              title='Back to Dashboard'
            >
              <svg
                class='h-5 w-5 flex-shrink-0 text-gray-400 group-hover:text-cyber-blue'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  stroke-linecap='round'
                  stroke-linejoin='round'
                  stroke-width='2'
                  d='M10 19l-7-7m0 0l7-7m-7 7h18'
                />
              </svg>
              <span x-show='!collapsed' class='flex-1 truncate font-medium'>
                Back to Dashboard
              </span>
            </a>
          </li>
        )
      }

      {/* Logout Button */}
      <li>
        <form action='/api/auth/logout' method='POST' class='w-full'>
          <button
            type='submit'
            class='sidebar-item group flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-gray-300 transition-all duration-200 hover:bg-night-steel hover:text-white'
            title='Log Out'
          >
            <SidebarIcon
              name='logout'
              class='h-5 w-5 flex-shrink-0 text-gray-400 group-hover:text-cyber-blue'
            />
            <span
              x-show='!collapsed'
              class='flex-1 truncate text-left font-medium'
            >
              Log Out
            </span>
          </button>
        </form>
      </li>

      {/* Additional footer items */}
      {
        footer?.items.map((item) => (
          <li>
            {item.href ?
              <a
                href={item.href}
                class='sidebar-item group flex items-center gap-3 rounded-lg px-3 py-2.5 text-gray-300 transition-all duration-200 hover:bg-night-steel hover:text-white'
                title={item.label}
              >
                {item.icon && (
                  <span class='flex-shrink-0 text-gray-400 group-hover:text-cyber-blue'>
                    <SidebarIcon name={item.icon} class='h-5 w-5' />
                  </span>
                )}
                <span x-show='!collapsed' class='flex-1 truncate font-medium'>
                  {item.label}
                </span>
              </a>
            : <button
                type='button'
                onclick={item.onClick}
                class='sidebar-item group flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-gray-300 transition-all duration-200 hover:bg-night-steel hover:text-white'
                title={item.label}
              >
                {item.icon && (
                  <span class='flex-shrink-0 text-gray-400 group-hover:text-cyber-blue'>
                    <SidebarIcon name={item.icon} class='h-5 w-5' />
                  </span>
                )}
                <span
                  x-show='!collapsed'
                  class='flex-1 truncate text-left font-medium'
                >
                  {item.label}
                </span>
              </button>
            }
          </li>
        ))
      }
    </ul>
  </div>
</aside>

<style>
  .sidebar-amina {
    @apply relative bg-night-shadow;
    border-right: 1px solid theme('colors.night.steel');
    height: 100vh;
    position: sticky;
    top: 0;
    overflow-y: auto;
  }

  /* Custom Scrollbar */
  .sidebar-nav::-webkit-scrollbar {
    width: 4px;
  }

  .sidebar-nav::-webkit-scrollbar-track {
    @apply bg-night-black;
  }

  .sidebar-nav::-webkit-scrollbar-thumb {
    @apply bg-night-steel rounded-full;
  }

  .sidebar-nav::-webkit-scrollbar-thumb:hover {
    @apply bg-night-slate;
  }

  /* Active item glow effect */
  .sidebar-item[aria-current='page'],
  .sidebar-item.active {
    position: relative;
  }

  .sidebar-item[aria-current='page']::before,
  .sidebar-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 70%;
    background: theme('colors.amina.crimson');
    border-radius: 0 4px 4px 0;
  }

  /* Collapsed state adjustments */
  [x-cloak] {
    display: none;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .sidebar-amina {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 40;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .sidebar-amina.mobile-open {
      transform: translateX(0);
    }
  }
</style>
