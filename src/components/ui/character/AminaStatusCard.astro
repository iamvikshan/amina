---
/**
 * Amina Status Card - Guardian's Current Status
 * =============================================
 * Displays Amina's live status with portrait, activity message, and quick stats
 * Uses data from /api/metrics endpoint
 */

import { ImagePaths } from '@/utils/cdn';

// Status to portrait mapping (based on Amina's story and character)
const statusPortraitMap = {
  online: ImagePaths.portraits.idle, // Ready for action
  idle: ImagePaths.portraits.success, // Relaxed but vigilant
  dnd: ImagePaths.portraits.alert, // Focused, do not disturb
  invisible: ImagePaths.portraits.error, // Offline/maintenance
} as const;

// Status display names and colors
const statusConfig = {
  online: {
    label: 'On Patrol',
    color: '#22c55e',
    dotColor: 'bg-discord-green',
    kaomoji: '[>]',
  },
  idle: {
    label: 'Idle',
    color: '#eab308',
    dotColor: 'bg-yellow-500',
    kaomoji: '[~]',
  },
  dnd: {
    label: 'In Battle',
    color: '#ef4444',
    dotColor: 'bg-red-500',
    kaomoji: '[!]',
  },
  invisible: {
    label: 'Offline',
    color: '#6b7280',
    dotColor: 'bg-gray-500',
    kaomoji: '[x]',
  },
} as const;
---

<div
  class="amina-status-card group relative bg-gradient-to-br from-night-steel/70 to-night-shadow/70 backdrop-blur-md border-2 border-cyber-blue/30 rounded-xl p-4 transition-all duration-500 hover:border-cyber-blue/60 hover:scale-[1.02] hover:shadow-[0_0_20px_rgba(0,206,209,0.3)]"
  data-status="loading"
>
  <!-- Top accent line -->
  <div
    class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-cyber-blue to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"
  >
  </div>

  <!-- Horizontal Layout: Portrait | Status & Message -->
  <div class="flex items-center gap-4">
    <!-- Portrait Container (Left) -->
    <div class="relative flex-shrink-0">
      <!-- Portrait Image with glow -->
      <div
        class="relative w-16 h-16 rounded-full border-2 transition-all duration-500 portrait-container"
        style="border-color: #00CED1; box-shadow: 0 0 12px rgba(0, 206, 209, 0.4);"
      >
        <img
          id="amina-portrait"
          src={ImagePaths.portraits.idle}
          alt="Amina Portrait"
          class="w-full h-full rounded-full object-cover pixelated"
          loading="lazy"
        />
      </div>

      <!-- Status Indicator (top-right corner) -->
      <div
        class="absolute -top-0.5 -right-0.5 w-5 h-5 rounded-full border-2 border-night-shadow flex items-center justify-center status-dot"
      >
        <div
          class="w-2.5 h-2.5 rounded-full animate-pulse"
          id="status-dot-inner"
        >
        </div>
      </div>
    </div>

    <!-- Content (Right) -->
    <div class="flex-1 min-w-0">
      <!-- Status Text -->
      <div class="mb-2">
        <p
          class="text-xs font-mono uppercase tracking-wider text-cyber-blue flex items-center gap-2 status-label"
        >
          <span class="status-kaomoji">[>]</span>
          <span id="status-text">On Patrol</span>
        </p>
      </div>

      <!-- Activity Message (Amina's dialogue) -->
      <div>
        <p
          id="amina-message"
          class="text-xs text-neutral-400 italic leading-snug font-dialogue line-clamp-2"
        >
          "Checking status..."
        </p>
      </div>
    </div>
  </div>

  <!-- Commented out for compact footer version - can be reused elsewhere -->
  <!-- Divider -->
  <!-- <div class='border-t border-night-steel/50 my-4'></div> -->

  <!-- Quick Stats Grid -->
  <!-- <div class='grid grid-cols-3 gap-2 mb-4'> -->
  <!-- Guilds -->
  <!-- <div class='text-center'>
      <div
        class='text-lg font-heading font-bold text-white stat-value'
        id='stat-guilds'
      >
        -
      </div>
      <div class='text-[10px] text-gray-500 uppercase tracking-wider'>
        Guilds
      </div>
    </div> -->

  <!-- Users -->
  <!-- <div class='text-center'>
      <div
        class='text-lg font-heading font-bold text-white stat-value'
        id='stat-users'
      >
        -
      </div>
      <div class='text-[10px] text-gray-500 uppercase tracking-wider'>
        Users
      </div>
    </div> -->

  <!-- Channels -->
  <!-- <div class='text-center'>
      <div
        class='text-lg font-heading font-bold text-white stat-value'
        id='stat-channels'
      >
        -
      </div>
      <div class='text-[10px] text-gray-500 uppercase tracking-wider'>
        Channels
      </div>
    </div>
  </div> -->

  <!-- Bottom Info -->
  <!-- <div class='flex items-center justify-between text-[10px] text-gray-500'> -->
  <!-- Ping -->
  <!-- <div class='flex items-center gap-1'>
      <svg class='w-3 h-3' fill='currentColor' viewBox='0 0 20 20'>
        <path
          fill-rule='evenodd'
          d='M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z'
          clip-rule='evenodd'></path>
      </svg>
      <span id='stat-ping'>-</span>
    </div> -->

  <!-- Night Guard Badge -->
  <!-- <div
      class='px-2 py-0.5 bg-amina-crimson/20 border border-amina-crimson/50 rounded text-amina-crimson font-bold uppercase tracking-wider'
    >
      Night Guard
    </div> -->

  <!-- Uptime -->
  <!-- <div class='flex items-center gap-1'>
      <svg class='w-3 h-3' fill='currentColor' viewBox='0 0 20 20'>
        <path
          fill-rule='evenodd'
          d='M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z'
          clip-rule='evenodd'></path>
      </svg>
      <span id='stat-uptime'>-</span>
    </div>
  </div> -->

  <!-- Bottom corner accent -->
  <div
    class="absolute bottom-2 right-2 w-6 h-6 border-r-2 border-b-2 border-amina-crimson/30 group-hover:border-amina-crimson/60 transition-colors duration-300"
  >
  </div>
</div>

<style>
  /* Pixelated rendering for portrait */
  .pixelated {
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
  }

  /* Portrait breathing animation */
  @keyframes portrait-breathe {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  .portrait-container {
    animation: portrait-breathe 4s ease-in-out infinite;
  }

  /* Stat value counter animation */
  @keyframes counter-pop {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.15);
    }
    100% {
      transform: scale(1);
    }
  }

  .stat-value.updated {
    animation: counter-pop 0.3s ease-out;
  }

  /* Font family for dialogue */
  .font-dialogue {
    font-family: 'Quicksand', 'Comfortaa', cursive, system-ui;
  }
</style>

<script>
  interface MetricsData {
    guilds: number;
    members: number;
    channels?: number;
    ping: number;
    status: 'online' | 'idle' | 'dnd' | 'invisible';
    uptimeHours?: number;
    presence?: {
      status: 'online' | 'idle' | 'dnd' | 'invisible';
      message: string;
      type: string;
      url: string;
    };
    cached?: boolean;
  }

  const METRICS_API = '/api/metrics';
  const REFRESH_INTERVAL = 60 * 1000; // 60 seconds (matches API cache)

  // Status to portrait mapping
  const STATUS_PORTRAITS = {
    online:
      'https://stuff.vikshan.me/amina/portraits/portrait-idle.png' as string,
    idle: 'https://stuff.vikshan.me/amina/portraits/portrait-success.png' as string,
    dnd: 'https://stuff.vikshan.me/amina/portraits/portrait-alert.png' as string,
    invisible:
      'https://stuff.vikshan.me/amina/portraits/portrait-error.png' as string,
  };

  // Status configuration
  const STATUS_CONFIG = {
    online: {
      label: 'On Patrol',
      color: '#22c55e',
      dotColor: 'bg-discord-green',
      kaomoji: '[>]',
    },
    idle: {
      label: 'Idle',
      color: '#eab308',
      dotColor: 'bg-yellow-500',
      kaomoji: '[~]',
    },
    dnd: {
      label: 'In Battle',
      color: '#ef4444',
      dotColor: 'bg-red-500',
      kaomoji: '[!]',
    },
    invisible: {
      label: 'Offline',
      color: '#6b7280',
      dotColor: 'bg-gray-500',
      kaomoji: '[x]',
    },
  };

  // Default messages by status (fallback if no presence message)
  const DEFAULT_MESSAGES = {
    online: '"Communities are everything. I\'ll protect them all."',
    idle: '"Taking a brief rest... but always watching."',
    dnd: '"In the middle of a mission. Focus mode active."',
    invisible: '"Maintenance mode. I\'ll be back soon!"',
  };

  // Format numbers compactly
  function formatCompact(num: number): string {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1) + 'M';
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
  }

  // Format uptime hours
  function formatUptime(hours: number): string {
    if (hours >= 24) {
      const days = Math.floor(hours / 24);
      return `${days}d`;
    }
    return `${hours.toFixed(1)}h`;
  }

  // Update the UI with fetched data
  function updateUI(data: MetricsData) {
    // Get ALL status cards on the page (mobile + desktop)
    const cards = document.querySelectorAll('.amina-status-card');

    const status = data.presence?.status || data.status || 'online';
    const config = STATUS_CONFIG[status];

    // Update each card instance
    cards.forEach((card, index) => {
      const portrait = card.querySelector(
        '#amina-portrait'
      ) as HTMLImageElement;
      const statusText = card.querySelector('#status-text');
      const statusKaomoji = card.querySelector('.status-kaomoji');
      const message = card.querySelector('#amina-message');
      const statusDot = card.querySelector('#status-dot-inner');
      const portraitContainer = card.querySelector(
        '.portrait-container'
      ) as HTMLElement;
      const statusLabel = card.querySelector('.status-label') as HTMLElement;

      // Update card status
      card?.setAttribute('data-status', status);

      // Update portrait
      if (portrait) {
        portrait.src = STATUS_PORTRAITS[status];
        portrait.alt = `Amina - ${config.label}`;
      }

      // Update status text and kaomoji
      if (statusText) statusText.textContent = config.label;
      if (statusKaomoji) statusKaomoji.textContent = config.kaomoji;

      // Update status label color
      if (statusLabel) {
        statusLabel.style.color = config.color;
      }

      // Update portrait border and glow
      if (portraitContainer) {
        portraitContainer.style.borderColor = config.color;
        portraitContainer.style.boxShadow = `0 0 15px ${config.color}66`;
      }

      // Update status dot
      if (statusDot) {
        statusDot.className = `w-2.5 h-2.5 rounded-full animate-pulse ${config.dotColor}`;
      }

      // Update activity message
      if (message) {
        const activityMessage = data.presence?.message
          ? `"${data.presence.message}"`
          : DEFAULT_MESSAGES[status];
        message.textContent = activityMessage;
      }
    });

    // Update stats with animation (commented out for compact footer)
    const updateStat = (id: string, value: string) => {
      const element = document.getElementById(id);
      if (element && element.textContent !== value) {
        element.textContent = value;
        element.classList.add('updated');
        setTimeout(() => element.classList.remove('updated'), 300);
      }
    };

    // Stats commented out for compact footer version
    // updateStat('stat-guilds', formatCompact(data.guilds));
    // updateStat('stat-users', formatCompact(data.members));
    // updateStat('stat-channels', formatCompact(data.channels || 0));
    // updateStat('stat-ping', `${data.ping}ms`);
    // updateStat(
    //   'stat-uptime',
    //   data.uptimeHours ? formatUptime(data.uptimeHours) : '-'
    // );
  }

  // Fetch metrics data
  async function fetchMetrics() {
    try {
      const response = await fetch(METRICS_API);
      if (!response.ok) {
        throw new Error(`API returned ${response.status}`);
      }

      const data = (await response.json()) as MetricsData;
      updateUI(data);
    } catch (error) {
      console.error('[AminaStatusCard] Failed to fetch metrics:', error);
      // Keep showing last known data or defaults
    }
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      fetchMetrics();
      setInterval(fetchMetrics, REFRESH_INTERVAL);
    });
  } else {
    fetchMetrics();
    setInterval(fetchMetrics, REFRESH_INTERVAL);
  }
</script>
