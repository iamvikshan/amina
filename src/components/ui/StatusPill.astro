---
/**
 * Status Pill - Floating System Status Indicator
 * ==============================================
 * Shows real-time system health from Uptime Kuma
 * Appears in bottom-right, fades when not hovered
 */

import { getUptimeStats } from '@/lib/uptime';

// Fetch uptime stats with monitor data
const uptimeStats = await getUptimeStats();

// Determine overall status based on monitor states
const totalMonitors = uptimeStats.monitors.length;
const downMonitors = uptimeStats.monitors.filter((m) => m.status !== 1).length;
const uptimePercentage = uptimeStats.uptime;

interface StatusConfig {
  level: 'operational' | 'degraded' | 'partial' | 'major';
  color: string;
  bgColor: string;
  glowColor: string;
  dotColor: string;
  message: string;
  messageMobile: string;
}

let statusConfig: StatusConfig;

if (downMonitors === 0 && uptimePercentage >= 99.5) {
  // All systems operational
  statusConfig = {
    level: 'operational',
    color: '#22c55e', // green-500
    bgColor: 'rgba(34, 197, 94, 0.1)',
    glowColor: 'rgba(34, 197, 94, 0.3)',
    dotColor: '#22c55e',
    message: 'Operational',
    messageMobile: 'Operational',
  };
} else if (
  downMonitors === 1 ||
  (uptimePercentage >= 97 && uptimePercentage < 99.5)
) {
  // Degraded performance
  statusConfig = {
    level: 'degraded',
    color: '#eab308', // yellow-500
    bgColor: 'rgba(234, 179, 8, 0.1)',
    glowColor: 'rgba(234, 179, 8, 0.3)',
    dotColor: '#eab308',
    message: 'Degraded',
    messageMobile: 'Degraded',
  };
} else if (
  (downMonitors >= 2 && downMonitors < totalMonitors / 2) ||
  (uptimePercentage >= 90 && uptimePercentage < 97)
) {
  // Partial outage
  statusConfig = {
    level: 'partial',
    color: '#f97316', // orange-500
    bgColor: 'rgba(249, 115, 22, 0.1)',
    glowColor: 'rgba(249, 115, 22, 0.3)',
    dotColor: '#f97316',
    message: 'Issues',
    messageMobile: 'Issues',
  };
} else {
  // Major outage
  statusConfig = {
    level: 'major',
    color: '#ef4444', // red-500
    bgColor: 'rgba(239, 68, 68, 0.1)',
    glowColor: 'rgba(239, 68, 68, 0.3)',
    dotColor: '#ef4444',
    message: 'Outage',
    messageMobile: 'Outage',
  };
}
---

<div
  id='status-pill-container'
  class='fixed bottom-6 right-6 z-50 transition-all duration-500'
  data-visible='true'
>
  <!-- Status Pill -->
  <a
    href='https://status.vikshan.me/status/amina'
    target='_blank'
    rel='noopener noreferrer'
    id='status-pill'
    class='status-pill group flex items-center gap-1 md:gap-1.5 px-1.5 py-1 md:px-2 md:py-1.5 rounded-full backdrop-blur-md border transition-all duration-300 hover:scale-105 shadow-lg text-xs'
    style={`background-color: ${statusConfig.bgColor}; border-color: ${statusConfig.color}; color: ${statusConfig.color};`}
    title={`Click to view detailed status (${uptimePercentage.toFixed(2)}% uptime, ${downMonitors}/${totalMonitors} down)`}
  >
    <!-- Pulsing Dot -->
    <div class='relative flex items-center justify-center'>
      <!-- Outer pulse ring -->
      <div
        class='absolute w-1.5 h-1.5 md:w-2 md:h-2 rounded-full animate-ping opacity-75'
        style={`background-color: ${statusConfig.dotColor};`}
      >
      </div>
      <!-- Inner solid dot -->
      <div
        class='relative w-1 h-1 md:w-1.5 md:h-1.5 rounded-full'
        style={`background-color: ${statusConfig.dotColor}; box-shadow: 0 0 6px ${statusConfig.glowColor};`}
      >
      </div>
    </div>

    <!-- Status Text (Desktop) -->
    <span class='hidden md:inline-block text-xs font-mono font-medium'>
      {statusConfig.message}
    </span>

    <!-- Status Text (Mobile) -->
    <span class='md:hidden text-[10px] font-mono font-medium'>
      {statusConfig.messageMobile}
    </span>

    <!-- External link icon -->
    <svg
      class='w-2 h-2 md:w-2.5 md:h-2.5 opacity-50 group-hover:opacity-100 transition-opacity'
      fill='none'
      stroke='currentColor'
      viewBox='0 0 24 24'
    >
      <path
        stroke-linecap='round'
        stroke-linejoin='round'
        stroke-width='2'
        d='M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14'
      ></path>
    </svg>
  </a>

  <!-- Dismiss Button -->
  <button
    id='dismiss-status-pill'
    class='absolute -top-1 -right-1 w-3.5 h-3.5 md:w-4 md:h-4 rounded-full bg-night-steel border border-gray-600 text-gray-400 hover:bg-gray-700 hover:text-white hover:border-gray-500 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100 shadow-lg'
    title='Dismiss status indicator'
    type='button'
  >
    <svg
      class='w-2 h-2 md:w-2.5 md:h-2.5'
      fill='currentColor'
      viewBox='0 0 20 20'
    >
      <path
        fill-rule='evenodd'
        d='M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z'
        clip-rule='evenodd'></path>
    </svg>
  </button>
</div>

<style>
  /* Auto-fade animation after initial display */
  .status-pill {
    animation: fadeInThenSemiTransparent 4s ease-out forwards;
  }

  @keyframes fadeInThenSemiTransparent {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }
    20% {
      opacity: 1;
      transform: translateY(0);
    }
    80% {
      opacity: 1;
    }
    100% {
      opacity: 0.3;
    }
  }

  /* Hover reveals full opacity */
  #status-pill-container:hover .status-pill {
    opacity: 1 !important;
    animation: none;
  }

  /* Show dismiss button on container hover */
  #status-pill-container:hover #dismiss-status-pill {
    opacity: 1;
  }

  /* Slide out animation when dismissed */
  @keyframes slideOut {
    to {
      opacity: 0;
      transform: translateX(200px);
    }
  }

  .dismissing {
    animation: slideOut 0.4s ease-in forwards;
  }
</style>

<script>
  // Client-side interaction logic
  const STORAGE_KEY = 'status-pill-dismissed';
  const container = document.getElementById('status-pill-container');
  const dismissBtn = document.getElementById('dismiss-status-pill');

  // Check if user previously dismissed
  if (localStorage.getItem(STORAGE_KEY) === 'true') {
    container?.remove();
  }

  // Handle dismiss button click
  dismissBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    // Add dismissing animation
    container?.classList.add('dismissing');

    // Store dismissal preference
    localStorage.setItem(STORAGE_KEY, 'true');

    // Remove from DOM after animation
    setTimeout(() => {
      container?.remove();
    }, 400);
  });

  // Prevent dismiss button from triggering link
  dismissBtn?.addEventListener('mouseenter', (e) => {
    e.stopPropagation();
  });
</script>
