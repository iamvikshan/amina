---
// User Avatar Dropdown Component
// Displays user avatar with dropdown menu for authenticated users
// Used in both main navbar and dashboard header

import {
  LogOut,
  HelpCircle,
  ExternalLink,
  Cookie,
  User,
  Shield,
  Moon,
  Sun,
} from 'lucide-react';
import ThemeIcon from '@components/ThemeIcon.astro';
import Avatar from '@components/ui/avatars/Avatar.astro';
import type { DiscordUser } from '@types';
import { URLS } from '@/config/site';

interface Props {
  userData: DiscordUser;
  avatarUrl: string;
  showPresence?: boolean;
  presence?: 'online' | 'idle' | 'dnd' | 'offline';
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
  guardianRank?: string;
}

const {
  userData,
  avatarUrl,
  showPresence = true,
  presence = 'online',
  size = 'md',
  guardianRank,
} = Astro.props;
---

<div class="relative user-avatar-dropdown">
  <!-- Avatar Button -->
  <button
    id="userAvatarButton"
    type="button"
    class="flex items-center gap-2 rounded-full ring-2 ring-cyber-blue/50 hover:ring-cyber-blue focus:ring-cyber-blue focus:outline-none transition-all duration-200 hover:scale-105"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <Avatar
      src={avatarUrl}
      alt={userData.global_name || userData.username}
      size={size}
      presence={presence}
      showPresence={showPresence}
    />
  </button>

  <!-- Dropdown Menu - Apple Liquid Glass Style -->
  <div
    id="userAvatarDropdown"
    class="hidden absolute right-0 mt-3 w-72 z-[9999] animate-dropdown"
  >
    <!-- Liquid Glass Container -->
    <div
      class="liquid-glass-dropdown rounded-2xl overflow-hidden shadow-[0_8px_32px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4)]"
    >
      {/* User Info Header */}
      <div class="liquid-glass-header px-4 py-4">
        <div class="flex items-center gap-3">
          <Avatar
            src={avatarUrl}
            alt={userData.global_name || userData.username}
            size="lg"
            presence={presence}
            showPresence={showPresence}
          />
          <div class="flex-1 min-w-0">
            <p
              class="text-sm font-semibold text-gray-900 dark:text-white truncate"
            >
              {userData.global_name || userData.username}
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
              @{userData.username}
            </p>
            {
              guardianRank && (
                <div class="inline-flex items-center gap-1.5 mt-2 px-2.5 py-1 rounded-full bg-cyber-blue/10 dark:bg-cyber-blue/20 border border-cyber-blue/20">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-cyber-blue"
                  >
                    <path d="M12 2L2 7l10 5 10-5-10-5z" />
                    <path d="M2 17l10 5 10-5" />
                    <path d="M2 12l10 5 10-5" />
                  </svg>
                  <span class="text-xs font-medium text-cyber-blue">
                    {guardianRank}
                  </span>
                </div>
              )
            }
          </div>
        </div>
      </div>

      {/* Menu Items */}
      <div class="py-1.5 px-2">
        {/* Profile */}
        <a
          href="/user"
          class="liquid-glass-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 transition-all duration-200"
        >
          <div
            class="flex items-center justify-center w-7 h-7 rounded-md bg-cyber-blue/10 dark:bg-cyber-blue/20"
          >
            <User className="h-4 w-4 text-cyber-blue" />
          </div>
          <span>Profile</span>
        </a>

        {/* Dashboard (only show on main nav) */}
        {
          !Astro.url.pathname.includes('/dash') && (
            <a
              href="/dash"
              class="liquid-glass-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 transition-all duration-200"
            >
              <div class="flex items-center justify-center w-7 h-7 rounded-md bg-imperial-gold/10 dark:bg-imperial-gold/20">
                <Shield className="h-4 w-4 text-imperial-gold" />
              </div>
              <span>Dashboard</span>
            </a>
          )
        }

        {/* Cookie Preferences */}
        <button
          type="button"
          id="cookiePreferencesButton"
          class="liquid-glass-item flex items-center gap-3 w-full px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 transition-all duration-200"
        >
          <div
            class="flex items-center justify-center w-7 h-7 rounded-md bg-amber-500/10 dark:bg-amber-500/20"
          >
            <Cookie className="h-4 w-4 text-amber-600 dark:text-amber-400" />
          </div>
          <span>Cookies</span>
        </button>

        <div
          class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-night-steel to-transparent my-2"
        >
        </div>

        {/* Theme Toggle */}
        <button
          type="button"
          id="themeToggleButton"
          class="liquid-glass-item flex items-center gap-3 w-full px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 transition-all duration-200"
        >
          <div
            class="flex items-center justify-center w-7 h-7 rounded-md bg-purple-500/10 dark:bg-amber-500/20"
          >
            <!-- Moon icon (shown in light mode) -->
            <Moon
              className="h-4 w-4 text-purple-600 dark:text-transparent dark:hidden"
            />
            <!-- Sun icon (shown in dark mode) -->
            <Sun
              className="h-4 w-4 text-amber-500 dark:text-amber-400 hidden dark:block"
            />
          </div>
          <span>Theme</span>
        </button>

        {/* Documentation */}
        <a
          href="https://docs.4mina.app"
          rel="noopener noreferrer"
          target="_blank"
          class="liquid-glass-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 transition-all duration-200"
        >
          <div
            class="flex items-center justify-center w-7 h-7 rounded-md bg-blue-500/10 dark:bg-blue-500/20"
          >
            <ExternalLink
              className="h-4 w-4 text-blue-500 dark:text-blue-400"
            />
          </div>
          <span>Documentation</span>
        </a>

        {/* Support */}
        <a
          href={URLS.support}
          rel="noopener noreferrer"
          target="_blank"
          class="liquid-glass-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 transition-all duration-200"
        >
          <div
            class="flex items-center justify-center w-7 h-7 rounded-md bg-green-500/10 dark:bg-green-500/20"
          >
            <HelpCircle
              className="h-4 w-4 text-green-500 dark:text-green-400"
            />
          </div>
          <span>Support</span>
        </a>

        <div
          class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-night-steel to-transparent my-2"
        >
        </div>

        {/* Logout */}
        <button
          id="logoutButton"
          type="button"
          class="liquid-glass-item flex items-center gap-3 w-full px-3 py-2.5 rounded-lg text-sm font-medium text-amina-crimson dark:text-amina-rose-red transition-all duration-200"
        >
          <div
            class="flex items-center justify-center w-7 h-7 rounded-md bg-amina-crimson/10 dark:bg-amina-crimson/20"
          >
            <LogOut className="h-4 w-4" />
          </div>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Apple Liquid Glass Effect */
  .liquid-glass-dropdown {
    /* Translucent glass background */
    background: rgba(255, 255, 255, 0.72);

    /* Backdrop blur for the glass effect */
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);

    /* Subtle border for depth */
    border: 1px solid rgba(255, 255, 255, 0.4);

    /* Multiple box shadows for depth and glow */
    box-shadow:
      0 0 0 1px rgba(0, 0, 0, 0.04),
      0 8px 32px rgba(0, 0, 0, 0.12),
      0 0 1px rgba(255, 255, 255, 0.8) inset;
  }

  /* Dark mode liquid glass */
  :global(.dark) .liquid-glass-dropdown {
    background: rgba(10, 10, 10, 0.72);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow:
      0 0 0 1px rgba(255, 255, 255, 0.06),
      0 8px 32px rgba(0, 0, 0, 0.4),
      0 0 1px rgba(255, 255, 255, 0.1) inset;
  }

  /* Header section with subtle gradient */
  .liquid-glass-header {
    background: linear-gradient(
      180deg,
      rgba(255, 255, 255, 0.1) 0%,
      rgba(255, 255, 255, 0) 100%
    );
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }

  :global(.dark) .liquid-glass-header {
    background: linear-gradient(
      180deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0) 100%
    );
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  /* Menu items with glass hover effect */
  .liquid-glass-item {
    position: relative;
    cursor: pointer;
    overflow: hidden;
  }

  .liquid-glass-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      rgba(30, 144, 255, 0.05) 0%,
      rgba(220, 20, 60, 0.05) 100%
    );
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: inherit;
  }

  .liquid-glass-item:hover::before {
    opacity: 1;
  }

  .liquid-glass-item:hover {
    background: rgba(30, 144, 255, 0.08);
    transform: translateX(2px);
  }

  :global(.dark) .liquid-glass-item:hover {
    background: rgba(30, 144, 255, 0.15);
  }

  /* Specular highlight effect on hover */
  .liquid-glass-item::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.5s ease;
  }

  .liquid-glass-item:hover::after {
    left: 100%;
  }

  /* Dropdown animation with fluid motion */
  @keyframes dropdown {
    from {
      opacity: 0;
      transform: translateY(-12px) scale(0.95);
      filter: blur(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }
  }

  .animate-dropdown {
    animation: dropdown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Avatar ring glow effect */
  .user-avatar-dropdown button:hover {
    filter: drop-shadow(0 0 8px rgba(30, 144, 255, 0.4));
  }

  /* Smooth transitions for all interactive elements */
  .liquid-glass-item,
  .liquid-glass-item > * {
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  }
</style>

<script>
  // Dropdown toggle functionality
  const avatarButton = document.getElementById('userAvatarButton');
  const dropdown = document.getElementById('userAvatarDropdown');

  function toggleDropdown() {
    dropdown?.classList.toggle('hidden');
    const isOpen = !dropdown?.classList.contains('hidden');
    avatarButton?.setAttribute('aria-expanded', String(isOpen));
  }

  function closeDropdown() {
    dropdown?.classList.add('hidden');
    avatarButton?.setAttribute('aria-expanded', 'false');
  }

  // Toggle on button click
  avatarButton?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDropdown();
  });

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const isClickInside =
      avatarButton?.contains(target) || dropdown?.contains(target);

    if (!isClickInside) {
      closeDropdown();
    }
  });

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeDropdown();
    }
  });

  // Handle theme toggle
  const themeToggleButton = document.getElementById('themeToggleButton');
  themeToggleButton?.addEventListener('click', (e) => {
    e.stopPropagation();

    // Get current theme
    const htmlElement = document.documentElement;
    const isDark = htmlElement.classList.contains('dark');

    // Toggle theme
    if (isDark) {
      htmlElement.classList.remove('dark');
      localStorage.setItem('hs_theme', 'default');
    } else {
      htmlElement.classList.add('dark');
      localStorage.setItem('hs_theme', 'dark');
    }

    // Dispatch theme change event
    window.dispatchEvent(
      new CustomEvent('on-hs-appearance-change', {
        detail: isDark ? 'default' : 'dark',
      })
    );
  });

  // Cookie Preferences - Placeholder for future implementation
  const cookiePreferencesButton = document.getElementById(
    'cookiePreferencesButton'
  );
  cookiePreferencesButton?.addEventListener('click', (e) => {
    e.stopPropagation();

    // TODO: Implement cookie preferences modal
    // This will open a modal/dialog where users can:
    // - View which cookies are used and why
    // - Enable/disable optional cookies (analytics, marketing, etc.)
    // - Note: Essential cookies (auth, session) cannot be disabled as they're required for functionality
    //
    // For now, show a simple alert
    alert(
      'Cookie preferences coming soon!\n\nThis site uses essential cookies for authentication and session management. If you do not wish to aloow cookies for Amina, simply log out'
    );
  });

  // Logout functionality
  const logoutButton = document.getElementById('logoutButton');
  logoutButton?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include',
      });

      if (response.ok) {
        window.location.href = '/';
      }
    } catch (error) {
      console.error('Logout failed:', error);
    }
  });
</script>
