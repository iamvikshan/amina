---
/**
 * Unified Global Header Component
 * ================================
 * Single header component for all pages (main site and dashboard)
 *
 * Features:
 * - Auth-aware navigation:
 *   * Logged out: Theme toggle + Login button
 *   * Logged in: User avatar dropdown (theme toggle inside)
 * - Mobile responsive with hamburger menu
 * - Guardian rank display for authenticated users
 * - Proper stacking context (isolation: isolate) to fix z-index issues
 * - No overflow-hidden on containers to allow dropdowns to render properly
 *
 * Navigation Links:
 * - Home
 * - Dashboard (shows on all pages for now, will be conditional later)
 * - Docs
 */

import ThemeIcon from '@components/ThemeIcon.astro';
import BrandLogo from '@components/BrandLogo.astro';
import UserAvatarDropdown from '@components/navigation/UserAvatarDropdown.astro';
import LoginBtn from '@components/ui/buttons/LoginBtn.astro';
import {
  getDiscordUserData,
  getAvatarUrl,
  getDiscordGuilds,
} from '@/lib/data-utils';
import { getGuardianRank } from '@/lib/guardian-ranks';
import type { DiscordUser, DiscordGuild } from '@types';

// Accept optional pre-fetched data to avoid duplicate API calls
interface Props {
  userData?: DiscordUser | null;
  discordGuilds?: DiscordGuild[];
}

const { userData: preFetchedUserData, discordGuilds: preFetchedGuilds } =
  Astro.props;

// Try to get user data - use pre-fetched if available, otherwise fetch
let userData = preFetchedUserData;
let isAuthenticated = !!userData;

// Only fetch if not provided as props
if (!userData) {
  try {
    userData = await getDiscordUserData(Astro.cookies);
    isAuthenticated = !!userData;
  } catch (error) {
    // If there's an error (like in prerendering when cookies aren't available),
    // just treat as logged out - this is expected behavior
    isAuthenticated = false;
  }
}

// Only fetch these if authenticated
let avatarUrl = '';
let guardianRank = null;
let managedGuildsCount = 0;

if (isAuthenticated && userData) {
  avatarUrl = getAvatarUrl(userData);

  // Use pre-fetched guilds if available, otherwise fetch
  const discordGuilds =
    preFetchedGuilds || (await getDiscordGuilds(Astro.cookies));

  // Filter to managed guilds only
  const managedGuilds = discordGuilds.filter((guild) => {
    const permissions = BigInt(guild.permissions);
    return (permissions & 0x8n) === 0x8n;
  });

  managedGuildsCount = managedGuilds.length;
  guardianRank = getGuardianRank(managedGuildsCount);
}

// Check if we're on a dashboard page
const isDashboardPage = Astro.url.pathname.startsWith('/dash');

// Unified global navigation links
// Don't show navigation links on dashboard pages - users can use logo to go home
// and docs is in the dropdown
const links = isDashboardPage
  ? []
  : [
      { name: 'Dashboard', url: '/dash' },
      { name: 'Docs', url: 'https://docs.4mina.app', target: '_blank' },
    ];

// Always go home to main page
const homeUrl = '/';
---

<!-- 
  Amina's Guardian Header - Akame ga Kill Inspired
  ================================================
  Main header with sticky positioning and proper stacking context
  Features:
  - Dark tactical aesthetic with crimson accents
  - Glassmorphism with backdrop blur
  - Responsive mobile/desktop layouts
  - Guardian rank display for authenticated users
-->
<header
  class="sticky top-0 inset-x-0 h-14 w-full border-b z-[100000] select-none border-gray-200 dark:border-night-steel/80 bg-white/60 dark:bg-night-black/40 backdrop-blur-md header-fade-in"
  style="isolation: isolate;"
>
  <section
    class="mx-auto w-full max-w-full md:max-w-screen-xl px-4 md:px-12 lg:px-20 flex items-center justify-between h-full"
  >
    <!-- Desktop Layout -->
    <div class="hidden lg:flex items-center space-x-12 flex-1">
      <!-- Brand Logo -->
      <a class="flex items-center space-x-2" href={homeUrl}>
        <span class="flex items-center space-x-2">
          <BrandLogo class="h-8 w-auto" />
          <span
            class="text-lg font-bold font-heading !leading-none inline-block text-white hover:text-amina-crimson transition-colors"
            style="margin-top:4px"
          >
            Amina
          </span>
        </span>
      </a>

      <!-- Desktop Navigation -->
      {
        links.length > 0 && (
          <nav aria-label="Main" class="flex items-center mt-1">
            <ul class="group flex list-none items-center space-x-1">
              {links.map((link) => (
                <li>
                  <a
                    href={link.url}
                    target={link.target}
                    class="group inline-flex h-8 w-max items-center justify-center rounded-md bg-transparent px-4 py text-sm font-medium transition-colors text-neutral-400 hover:text-amina-crimson focus:text-amina-crimson focus:outline-none disabled:pointer-events-none disabled:opacity-50"
                  >
                    {link.name}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        )
      }
    </div>

    <!-- Desktop Right Side -->
    <div class="hidden lg:flex items-center">
      <!-- Auth Section -->
      {
        isAuthenticated && userData ? (
          // Logged in: Only show avatar (theme toggle is in dropdown)
          <div class="flex items-center gap-x-3">
            <UserAvatarDropdown
              userData={userData}
              avatarUrl={avatarUrl}
              guardianRank={
                guardianRank
                  ? `Lv${guardianRank.level} ${guardianRank.name}`
                  : undefined
              }
              showPresence={true}
              presence="online"
              size="sm"
            />
          </div>
        ) : (
          // Logged out: Show theme toggle + login button
          <>
            <span class="mt-1 mr-4">
              <ThemeIcon />
            </span>
            <LoginBtn />
          </>
        )
      }
    </div>

    <!-- Mobile Layout -->
    <div class="flex lg:hidden items-center justify-between w-full px-2">
      <!-- Mobile Menu Button -->
      <button
        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amina-crimson focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 active:scale-95 transition-all hover:bg-night-shadow hover:text-amina-crimson h-8 w-8 ml-5"
        type="button"
        data-hs-collapse="#navbar-mobile-menu"
        aria-controls="navbar-mobile-menu"
        aria-label="Toggle navigation"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-menu w-5 h-5 hs-collapse-open:hidden"
        >
          <line x1="4" x2="20" y1="12" y2="12"></line>
          <line x1="4" x2="20" y1="6" y2="6"></line>
          <line x1="4" x2="20" y1="18" y2="18"></line>
        </svg>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-x w-5 h-5 hidden hs-collapse-open:block"
        >
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </button>

      <!-- Mobile Right Controls -->
      <div class="flex items-center gap-x-2">
        <!-- User Avatar or Login -->
        {
          isAuthenticated && userData ? (
            // Logged in: Only show avatar (theme toggle is in dropdown)
            <UserAvatarDropdown
              userData={userData}
              avatarUrl={avatarUrl}
              guardianRank={
                guardianRank
                  ? `Lv${guardianRank.level} ${guardianRank.name}`
                  : undefined
              }
              showPresence={false}
              presence="online"
              size="xs"
            />
          ) : (
            // Logged out: Show theme toggle + login button
            <>
              <ThemeIcon />
              <LoginBtn />
            </>
          )
        }
      </div>
    </div>
  </section>

  <!-- Mobile Navigation Menu (Collapsible) -->
  <div
    id="navbar-mobile-menu"
    class="hs-collapse hidden w-full overflow-hidden transition-all duration-300 lg:hidden"
  >
    <div
      class="border-t border-night-steel/80 bg-night-shadow/95 backdrop-blur-md"
    >
      <nav class="flex flex-col space-y-1 px-4 py-4">
        {
          links.map((link) => (
            <a
              href={link.url}
              target={link.target}
              class="px-4 py-3 rounded-md text-sm font-medium text-neutral-400 hover:text-amina-crimson hover:bg-night-black/60 transition-colors"
            >
              {link.name}
            </a>
          ))
        }
      </nav>
    </div>
  </div>
</header>

<style>
  /* Amina's Guardian Header Styles - Akame ga Kill Inspired */

  /* Smooth fade-in transition from skeleton to loaded header */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .header-fade-in {
    animation: fadeIn 0.4s ease-out;
  }

  /* Crimson glow on button hover - Amina's signature */
  header button:hover {
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.4);
  }

  /* Navigation link hover effect with crimson glow */
  nav a:hover {
    text-shadow: 0 0 8px rgba(220, 20, 60, 0.6);
  }

  /* Active link indicator */
  nav a[aria-current='page'] {
    color: #dc143c;
    position: relative;
  }

  nav a[aria-current='page']::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #dc143c 0%, #e63946 100%);
    box-shadow: 0 0 8px rgba(220, 20, 60, 0.6);
  }

  /* Click feedback with scale */
  header button:active {
    transform: scale(0.95);
  }

  /* Theme toggle cursor */
  [data-theme-click] {
    cursor: pointer;
    user-select: none;
  }

  /* Mobile menu slide animation */
  #navbar-mobile-menu {
    transform-origin: top;
  }

  #navbar-mobile-menu.hs-collapse-open {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Glassmorphism enhancement */
  header {
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  /* Brand logo glow on hover */
  header a[href='/']:hover {
    filter: drop-shadow(0 0 8px rgba(220, 20, 60, 0.5));
  }

  /* Mobile menu items hover effect */
  #navbar-mobile-menu nav a {
    transition: all 0.2s ease;
  }

  #navbar-mobile-menu nav a:hover {
    transform: translateX(4px);
    border-left: 2px solid #dc143c;
    padding-left: 1rem;
  }
</style>

<!-- Theme Appearance script to manage light/dark modes -->
<script is:inline>
  const themeContainer = document.querySelector('[data-theme-click]');
  if (themeContainer) {
    themeContainer.addEventListener('click', (e) => {
      // Find the closest clickable theme value element
      const themeElement = e.target?.closest('[data-hs-theme-click-value]');
      if (themeElement) {
        const value = themeElement.getAttribute('data-hs-theme-click-value');
        if (value) {
          HSThemeAppearance.setAppearance(value, true, themeElement);
        }
      }
    });
  }

  const HSThemeAppearance = {
    init() {
      const defaultTheme = 'default';
      let theme = localStorage.getItem('hs_theme') || defaultTheme;

      if (document.querySelector('html').classList.contains('dark')) return;
      this.setAppearance(theme);
    },
    _resetStylesOnLoad() {
      const $resetStyles = document.createElement('style');
      $resetStyles.innerText = `*{transition: unset !important;}`;
      $resetStyles.setAttribute('data-hs-appearance-onload-styles', '');
      document.head.appendChild($resetStyles);
      return $resetStyles;
    },
    setAppearance(theme, saveInStore = true, dispatchEvent = true) {
      const $resetStylesEl = this._resetStylesOnLoad();

      if (saveInStore) {
        localStorage.setItem('hs_theme', theme);
      }

      if (theme === 'auto') {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches
          ? 'dark'
          : 'default';
      }

      document.querySelector('html').classList.remove('dark');
      document.querySelector('html').classList.remove('default');
      document.querySelector('html').classList.remove('auto');

      document
        .querySelector('html')
        .classList.add(this.getOriginalAppearance());

      setTimeout(() => {
        $resetStylesEl.remove();
      });

      if (dispatchEvent) {
        window.dispatchEvent(
          new CustomEvent('on-hs-appearance-change', { detail: theme })
        );
      }
    },
    getAppearance() {
      let theme = this.getOriginalAppearance();
      if (theme === 'auto') {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches
          ? 'dark'
          : 'default';
      }
      return theme;
    },
    getOriginalAppearance() {
      const defaultTheme = 'default';
      return localStorage.getItem('hs_theme') || defaultTheme;
    },
  };
  HSThemeAppearance.init();

  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (e) => {
      if (HSThemeAppearance.getOriginalAppearance() === 'auto') {
        HSThemeAppearance.setAppearance('auto', false);
      }
    });

  window.addEventListener('load', () => {
    const $clickableThemes = document.querySelectorAll(
      '[data-hs-theme-click-value]'
    );
    const $switchableThemes = document.querySelectorAll(
      '[data-hs-theme-switch]'
    );

    $clickableThemes.forEach(($item) => {
      $item.addEventListener('click', () =>
        HSThemeAppearance.setAppearance(
          $item.getAttribute('data-hs-theme-click-value'),
          true,
          $item
        )
      );
    });

    $switchableThemes.forEach(($item) => {
      $item.addEventListener('change', (e) => {
        HSThemeAppearance.setAppearance(e.target.checked ? 'dark' : 'default');
      });

      $item.checked = HSThemeAppearance.getAppearance() === 'dark';
    });

    window.addEventListener('on-hs-appearance-change', (e) => {
      $switchableThemes.forEach(($item) => {
        $item.checked = e.detail === 'dark';
      });
    });
  });
</script>
