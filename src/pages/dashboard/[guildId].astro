---
export const prerender = false;

import DashLayout from '@/layouts/DashLayout.astro';
import { GuildManager } from '@/lib/database/mongoose';
import type { IGuild } from '@/lib/database/types/guild';
import { getDiscordUserData } from '@/lib/data-utils';

const { guildId } = Astro.params;

if (!guildId) {
  return Astro.redirect('/dash');
}

let guild: IGuild | null = null;
let error: string | null = null;
let userData = null;

try {
  // Get user data
  userData = await getDiscordUserData(Astro.cookies);

  // Fetch guild settings from database
  const guildManager = await GuildManager.getInstance();
  guild = await guildManager.getGuild(guildId);

  if (!guild) {
    error = 'Guild not found. Please add the bot to your server first.';
  } else if (guild.server.leftAt) {
    error =
      'The bot has left this server. Please re-add it to manage settings.';
  }
} catch (err) {
  console.error('Error loading guild dashboard:', err);
  error = 'Failed to load guild settings. Please try again.';
}

// If there's an error, show error page
if (error || !guild) {
  return Astro.redirect(
    `/dash?error=${encodeURIComponent(error || 'Unknown error')}`
  );
}

const pageTitle = `${guild.server.name} - Dashboard`;
---

<DashLayout
  title={pageTitle}
  description={`Manage settings for ${guild.server.name}`}
>
  <div class='min-h-screen bg-gray-50 dark:bg-gray-900'>
    <!-- Header -->
    <div
      class='bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700'
    >
      <div class='container mx-auto px-4 py-6'>
        <div class='flex items-center gap-4'>
          <a
            href='/dash'
            class='text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors'
          >
            <svg
              class='w-6 h-6'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path
                stroke-linecap='round'
                stroke-linejoin='round'
                stroke-width='2'
                d='M10 19l-7-7m0 0l7-7m-7 7h18'></path>
            </svg>
          </a>
          <div>
            <h1 class='text-2xl font-bold text-gray-900 dark:text-white'>
              {guild.server.name}
            </h1>
            <p class='text-sm text-gray-600 dark:text-gray-400'>
              Server Configuration
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div
      class='bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700'
    >
      <div class='container mx-auto px-4'>
        <nav class='flex space-x-8' x-data="{ activeTab: 'overview' }">
          <button
            @click="activeTab = 'overview'"
            :class="activeTab === 'overview' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300'"
            class='py-4 px-1 border-b-2 font-medium text-sm transition-colors'
          >
            Overview
          </button>
          <button
            @click="activeTab = 'moderation'"
            :class="activeTab === 'moderation' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300'"
            class='py-4 px-1 border-b-2 font-medium text-sm transition-colors'
          >
            Moderation
          </button>
          <button
            @click="activeTab = 'logging'"
            :class="activeTab === 'logging' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300'"
            class='py-4 px-1 border-b-2 font-medium text-sm transition-colors'
          >
            Logging
          </button>
          <button
            @click="activeTab = 'welcome'"
            :class="activeTab === 'welcome' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300'"
            class='py-4 px-1 border-b-2 font-medium text-sm transition-colors'
          >
            Welcome
          </button>
          <button
            @click="activeTab = 'levels'"
            :class="activeTab === 'levels' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300'"
            class='py-4 px-1 border-b-2 font-medium text-sm transition-colors'
          >
            Levels & XP
          </button>
          <button
            @click="activeTab = 'tickets'"
            :class="activeTab === 'tickets' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300'"
            class='py-4 px-1 border-b-2 font-medium text-sm transition-colors'
          >
            Tickets
          </button>
        </nav>
      </div>
    </div>

    <!-- Tab Content -->
    <div class='container mx-auto px-4 py-8' x-data='guildDashboard()'>
      <!-- Overview Tab -->
      <div
        x-show="$root.querySelector('[x-data]').activeTab === 'overview'"
        id='overview-tab'
      >
        <div class='max-w-4xl'>
          <h2 class='text-xl font-semibold text-gray-900 dark:text-white mb-4'>
            Server Overview
          </h2>

          <div
            class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 space-y-4'
          >
            <div class='grid grid-cols-2 gap-4'>
              <div>
                <p class='text-sm text-gray-600 dark:text-gray-400'>
                  Server Name
                </p>
                <p class='text-lg font-medium text-gray-900 dark:text-white'>
                  {guild.server.name}
                </p>
              </div>
              <div>
                <p class='text-sm text-gray-600 dark:text-gray-400'>Region</p>
                <p class='text-lg font-medium text-gray-900 dark:text-white'>
                  {guild.server.region}
                </p>
              </div>
              <div>
                <p class='text-sm text-gray-600 dark:text-gray-400'>
                  Bot Joined
                </p>
                <p class='text-lg font-medium text-gray-900 dark:text-white'>
                  {new Date(guild.server.joinedAt).toLocaleDateString()}
                </p>
              </div>
              <div>
                <p class='text-sm text-gray-600 dark:text-gray-400'>
                  Setup Completed
                </p>
                <p class='text-lg font-medium text-gray-900 dark:text-white'>
                  {guild.server.setup_completed ? '‚úÖ Yes' : '‚ùå No'}
                </p>
              </div>
            </div>

            {
              !guild.server.setup_completed && (
                <div class='mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg'>
                  <p class='text-sm text-yellow-800 dark:text-yellow-200'>
                    ‚ö†Ô∏è Server setup is not complete. Run{' '}
                    <code class='px-2 py-1 bg-yellow-100 dark:bg-yellow-900 rounded'>
                      /settings
                    </code>{' '}
                    in Discord to finish setup.
                  </p>
                </div>
              )
            }
          </div>
        </div>
      </div>

      <!-- Moderation Tab -->
      <div
        x-show="$root.querySelector('[x-data]').activeTab === 'moderation'"
        id='moderation-tab'
      >
        <div class='max-w-4xl'>
          <h2 class='text-xl font-semibold text-gray-900 dark:text-white mb-4'>
            Moderation Settings
          </h2>

          <!-- Automod Section -->
          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6'>
            <h3
              class='text-lg font-semibold text-gray-900 dark:text-white mb-4'
            >
              Auto-Moderation
            </h3>

            <form
              @submit.prevent="saveSettings('automod', { automod: guild.automod })"
            >
              <div class='space-y-6'>
                <!-- Strikes & Action -->
                <div class='grid grid-cols-2 gap-4'>
                  <div>
                    <label
                      class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                    >
                      Max Strikes
                    </label>
                    <input
                      type='number'
                      x-model='guild.automod.strikes'
                      min='1'
                      max='100'
                      class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    />
                  </div>
                  <div>
                    <label
                      class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                    >
                      Action on Max Strikes
                    </label>
                    <select
                      x-model='guild.automod.action'
                      class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    >
                      <option value='TIMEOUT'>Timeout</option>
                      <option value='KICK'>Kick</option>
                      <option value='BAN'>Ban</option>
                    </select>
                  </div>
                </div>

                <!-- Toggle Options -->
                <div class='space-y-4'>
                  <div class='flex items-center justify-between'>
                    <div>
                      <label
                        class='text-sm font-medium text-gray-900 dark:text-white'
                      >
                        Anti Ghost Ping
                      </label>
                      <p class='text-xs text-gray-600 dark:text-gray-400'>
                        Detect and log deleted messages that ping users
                      </p>
                    </div>
                    <label
                      class='relative inline-flex items-center cursor-pointer'
                    >
                      <input
                        type='checkbox'
                        x-model='guild.automod.anti_ghostping'
                        class='sr-only peer'
                      />
                      <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                      >
                      </div>
                    </label>
                  </div>

                  <div class='flex items-center justify-between'>
                    <div>
                      <label
                        class='text-sm font-medium text-gray-900 dark:text-white'
                      >
                        Anti Spam
                      </label>
                      <p class='text-xs text-gray-600 dark:text-gray-400'>
                        Detect and prevent message spam
                      </p>
                    </div>
                    <label
                      class='relative inline-flex items-center cursor-pointer'
                    >
                      <input
                        type='checkbox'
                        x-model='guild.automod.anti_spam'
                        class='sr-only peer'
                      />
                      <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                      >
                      </div>
                    </label>
                  </div>

                  <div class='flex items-center justify-between'>
                    <div>
                      <label
                        class='text-sm font-medium text-gray-900 dark:text-white'
                      >
                        Anti Invites
                      </label>
                      <p class='text-xs text-gray-600 dark:text-gray-400'>
                        Block Discord invite links
                      </p>
                    </div>
                    <label
                      class='relative inline-flex items-center cursor-pointer'
                    >
                      <input
                        type='checkbox'
                        x-model='guild.automod.anti_invites'
                        class='sr-only peer'
                      />
                      <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                      >
                      </div>
                    </label>
                  </div>

                  <div class='flex items-center justify-between'>
                    <div>
                      <label
                        class='text-sm font-medium text-gray-900 dark:text-white'
                      >
                        Anti Links
                      </label>
                      <p class='text-xs text-gray-600 dark:text-gray-400'>
                        Block external links
                      </p>
                    </div>
                    <label
                      class='relative inline-flex items-center cursor-pointer'
                    >
                      <input
                        type='checkbox'
                        x-model='guild.automod.anti_links'
                        class='sr-only peer'
                      />
                      <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                      >
                      </div>
                    </label>
                  </div>

                  <div class='flex items-center justify-between'>
                    <div>
                      <label
                        class='text-sm font-medium text-gray-900 dark:text-white'
                      >
                        Anti Attachments
                      </label>
                      <p class='text-xs text-gray-600 dark:text-gray-400'>
                        Block file attachments
                      </p>
                    </div>
                    <label
                      class='relative inline-flex items-center cursor-pointer'
                    >
                      <input
                        type='checkbox'
                        x-model='guild.automod.anti_attachments'
                        class='sr-only peer'
                      />
                      <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                      >
                      </div>
                    </label>
                  </div>
                </div>

                <!-- Mass Mention Limit -->
                <div>
                  <label
                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                  >
                    Mass Mention Limit
                  </label>
                  <input
                    type='number'
                    x-model='guild.automod.anti_massmention'
                    min='0'
                    max='50'
                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    placeholder='0 = disabled'
                  />
                  <p class='text-xs text-gray-600 dark:text-gray-400 mt-1'>
                    Maximum number of mentions allowed per message
                  </p>
                </div>

                <!-- Save Button -->
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>

          <!-- Max Warnings Section -->
          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6'>
            <h3
              class='text-lg font-semibold text-gray-900 dark:text-white mb-4'
            >
              Warning System
            </h3>

            <form
              @submit.prevent="saveSettings('warnings', { max_warn: guild.max_warn })"
            >
              <div class='space-y-6'>
                <div class='grid grid-cols-2 gap-4'>
                  <div>
                    <label
                      class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                    >
                      Max Warnings
                    </label>
                    <input
                      type='number'
                      x-model='guild.max_warn.limit'
                      min='1'
                      max='50'
                      class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    />
                  </div>
                  <div>
                    <label
                      class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                    >
                      Action on Max Warnings
                    </label>
                    <select
                      x-model='guild.max_warn.action'
                      class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    >
                      <option value='TIMEOUT'>Timeout</option>
                      <option value='KICK'>Kick</option>
                      <option value='BAN'>Ban</option>
                    </select>
                  </div>
                </div>

                <!-- Save Button -->
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Logging Tab -->
      <div
        x-show="$root.querySelector('[x-data]').activeTab === 'logging'"
        id='logging-tab'
      >
        <div class='max-w-4xl'>
          <h2 class='text-xl font-semibold text-gray-900 dark:text-white mb-4'>
            Logging Settings
          </h2>

          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6'>
            <form
              @submit.prevent="saveSettings('logging', { logs: guild.logs })"
            >
              <div class='space-y-6'>
                <!-- Enable Logging -->
                <div
                  class='flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700'
                >
                  <div>
                    <label
                      class='text-lg font-semibold text-gray-900 dark:text-white'
                    >
                      Enable Logging
                    </label>
                    <p class='text-sm text-gray-600 dark:text-gray-400'>
                      Master switch for all logging features
                    </p>
                  </div>
                  <label
                    class='relative inline-flex items-center cursor-pointer'
                  >
                    <input
                      type='checkbox'
                      x-model='guild.logs.enabled'
                      class='sr-only peer'
                    />
                    <div
                      class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                    >
                    </div>
                  </label>
                </div>

                <!-- Member Events -->
                <div>
                  <h4 class='font-medium text-gray-900 dark:text-white mb-3'>
                    Member Events
                  </h4>
                  <div class='space-y-3'>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Message Edits
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.member.message_edit'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Message Deletions
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.member.message_delete'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Role Changes
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.member.role_changes'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Channel Events -->
                <div>
                  <h4 class='font-medium text-gray-900 dark:text-white mb-3'>
                    Channel Events
                  </h4>
                  <div class='space-y-3'>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Channel Created
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.channel.create'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Channel Edited
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.channel.edit'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Channel Deleted
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.channel.delete'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Role Events -->
                <div>
                  <h4 class='font-medium text-gray-900 dark:text-white mb-3'>
                    Role Events
                  </h4>
                  <div class='space-y-3'>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Role Created
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.role.create'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Role Edited
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.role.edit'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                    <div class='flex items-center justify-between'>
                      <label class='text-sm text-gray-700 dark:text-gray-300'>
                        Role Deleted
                      </label>
                      <label
                        class='relative inline-flex items-center cursor-pointer'
                      >
                        <input
                          type='checkbox'
                          x-model='guild.logs.role.delete'
                          class='sr-only peer'
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                        >
                        </div>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Save Button -->
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Welcome Tab -->
      <div
        x-show="$root.querySelector('[x-data]').activeTab === 'welcome'"
        id='welcome-tab'
      >
        <div class='max-w-4xl space-y-6'>
          <h2 class='text-xl font-semibold text-gray-900 dark:text-white mb-4'>
            Welcome & Farewell Messages
          </h2>

          <!-- Welcome Section -->
          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6'>
            <h3
              class='text-lg font-semibold text-gray-900 dark:text-white mb-4'
            >
              Welcome Messages
            </h3>
            <form
              @submit.prevent="saveSettings('welcome', { welcome: guild.welcome })"
            >
              <div class='space-y-4'>
                <div class='flex items-center justify-between'>
                  <label
                    class='text-sm font-medium text-gray-900 dark:text-white'
                  >
                    Enable Welcome Messages
                  </label>
                  <label
                    class='relative inline-flex items-center cursor-pointer'
                  >
                    <input
                      type='checkbox'
                      x-model='guild.welcome.enabled'
                      class='sr-only peer'
                    />
                    <div
                      class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                    >
                    </div>
                  </label>
                </div>
                <div>
                  <label
                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                  >
                    Welcome Message
                  </label>
                  <textarea
                    x-model='guild.welcome.content'
                    rows='3'
                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    placeholder='Welcome {member:mention} to {server}!'
                  ></textarea>
                  <p class='text-xs text-gray-600 dark:text-gray-400 mt-1'>
                    Variables: &#123;member:mention&#125;,
                    &#123;member:tag&#125;, &#123;server&#125;,
                    &#123;count&#125;
                  </p>
                </div>
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>

          <!-- Farewell Section -->
          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6'>
            <h3
              class='text-lg font-semibold text-gray-900 dark:text-white mb-4'
            >
              Farewell Messages
            </h3>
            <form
              @submit.prevent="saveSettings('farewell', { farewell: guild.farewell })"
            >
              <div class='space-y-4'>
                <div class='flex items-center justify-between'>
                  <label
                    class='text-sm font-medium text-gray-900 dark:text-white'
                  >
                    Enable Farewell Messages
                  </label>
                  <label
                    class='relative inline-flex items-center cursor-pointer'
                  >
                    <input
                      type='checkbox'
                      x-model='guild.farewell.enabled'
                      class='sr-only peer'
                    />
                    <div
                      class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                    >
                    </div>
                  </label>
                </div>
                <div>
                  <label
                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                  >
                    Farewell Message
                  </label>
                  <textarea
                    x-model='guild.farewell.content'
                    rows='3'
                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    placeholder='Goodbye {member:tag}! üëã'></textarea>
                </div>
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Levels Tab -->
      <div
        x-show="$root.querySelector('[x-data]').activeTab === 'levels'"
        id='levels-tab'
      >
        <div class='max-w-4xl'>
          <h2 class='text-xl font-semibold text-gray-900 dark:text-white mb-4'>
            Levels & XP System
          </h2>
          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6'>
            <form
              @submit.prevent="saveSettings('stats', { stats: guild.stats })"
            >
              <div class='space-y-6'>
                <div class='flex items-center justify-between'>
                  <div>
                    <label
                      class='text-lg font-semibold text-gray-900 dark:text-white'
                    >
                      Enable XP System
                    </label>
                    <p class='text-sm text-gray-600 dark:text-gray-400'>
                      Award XP to members for sending messages
                    </p>
                  </div>
                  <label
                    class='relative inline-flex items-center cursor-pointer'
                  >
                    <input
                      type='checkbox'
                      x-model='guild.stats.enabled'
                      class='sr-only peer'
                    />
                    <div
                      class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                    >
                    </div>
                  </label>
                </div>
                <div>
                  <label
                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                  >
                    Level-Up Message
                  </label>
                  <textarea
                    x-model='guild.stats.xp.message'
                    rows='3'
                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                    placeholder='{member:tag}, Yay! üéâ You just leveled up to Level {level}! üåü'
                  ></textarea>
                  <p class='text-xs text-gray-600 dark:text-gray-400 mt-1'>
                    Variables: &#123;member:tag&#125;,
                    &#123;member:mention&#125;, &#123;level&#125;
                  </p>
                </div>
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tickets Tab -->
      <div
        x-show="$root.querySelector('[x-data]').activeTab === 'tickets'"
        id='tickets-tab'
      >
        <div class='max-w-4xl'>
          <h2 class='text-xl font-semibold text-gray-900 dark:text-white mb-4'>
            Ticket System
          </h2>
          <div class='bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6'>
            <form
              @submit.prevent="saveSettings('ticket', { ticket: guild.ticket })"
            >
              <div class='space-y-6'>
                <div class='flex items-center justify-between'>
                  <div>
                    <label
                      class='text-lg font-semibold text-gray-900 dark:text-white'
                    >
                      Enable Ticket System
                    </label>
                    <p class='text-sm text-gray-600 dark:text-gray-400'>
                      Allow members to create support tickets
                    </p>
                  </div>
                  <label
                    class='relative inline-flex items-center cursor-pointer'
                  >
                    <input
                      type='checkbox'
                      x-model='guild.ticket.enabled'
                      class='sr-only peer'
                    />
                    <div
                      class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"
                    >
                    </div>
                  </label>
                </div>
                <div>
                  <label
                    class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'
                  >
                    Maximum Tickets per User
                  </label>
                  <input
                    type='number'
                    x-model='guild.ticket.limit'
                    min='1'
                    max='25'
                    class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white'
                  />
                </div>
                <div
                  class='flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700'
                >
                  <button
                    type='submit'
                    class='px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50'
                    :disabled='saving'
                  >
                    <span x-show='!saving'>Save Changes</span>
                    <span x-show='saving'>Saving...</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ guildData: guild }}>
    function guildDashboard() {
      return {
        guild: guildData,
        saving: false,
        hasUnsavedChanges: false,

        async saveSettings(section, data) {
          this.saving = true;
          try {
            const response = await fetch(
              `/api/guild/${this.guild._id}/${section}`,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
              }
            );

            if (!response.ok) {
              throw new Error('Failed to save settings');
            }

            const result = await response.json();
            this.guild = result.guild;
            this.hasUnsavedChanges = false;

            // Show success notification
            this.showNotification('Settings saved successfully!', 'success');
          } catch (error) {
            console.error('Save error:', error);
            this.showNotification(
              'Failed to save settings. Please try again.',
              'error'
            );
          } finally {
            this.saving = false;
          }
        },

        showNotification(message, type) {
          // Create toast element
          const toast = document.createElement('div');
          toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
          }`;
          toast.textContent = message;
          document.body.appendChild(toast);

          // Animate in
          setTimeout(() => {
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
          }, 10);

          // Remove after 3 seconds
          setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        },
      };
    }
  </script>
</DashLayout>
