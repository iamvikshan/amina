---
// @/pages/auth/callback.astro

import { discordAuth } from '@/lib/discord-auth';
import { setAuthCookies, getAuthCookies } from '@/lib/cookie-utils';

export const prerender = false;

if (Astro.request.method === 'GET') {
  const url = new URL(Astro.request.url);
  const code = url.searchParams.get('code');
  const error = url.searchParams.get('error');

  if (error) {
    console.error('âœ¨ Oops! Discord auth hit a snag:', error);
    return Astro.redirect('/', 302);
  }

  if (!code) {
    console.error('ðŸŽ­ Hey! We need a secret code to let you in!');
    return Astro.redirect('/', 302);
  }

  try {
    const tokenData = await discordAuth.exchangeCode(code);
    const userData = await discordAuth.getUserInfo(tokenData.access_token);

    setAuthCookies(Astro.cookies, tokenData, userData);

    return Astro.redirect('/dash', 302);
  } catch (err) {
    console.error('Authentication failed:', err);
    return Astro.redirect('/', 302);
  }
}
---
