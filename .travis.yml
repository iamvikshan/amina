# Travis CI Configuration for Amina Discord Bot
# Uses Doppler CLI for secrets management
# Free for students: https://education.travis-ci.com/

language: minimal
os: linux
dist: jammy

# Cache bun dependencies
cache:
  directories:
    - ~/.bun/install/cache

# Environment variables (DOPPLER_TOKEN should be set in Travis CI settings)
env:
  global:
    - DOPPLER_PROJECT=amina
    - DOPPLER_CONFIG=dev

stages:
  - name: lint
    if: type = pull_request OR branch = main
  - name: test
    if: type = pull_request OR branch = main
  - name: docker
    if: branch = main AND type = push

jobs:
  include:
    # ============================================
    # Stage: Lint & Type Check (Pre-build)
    # ============================================
    - stage: lint
      name: "TypeScript & ESLint Check"
      install:
        # Install Bun
        - curl -fsSL https://bun.sh/install | bash
        - export BUN_INSTALL="$HOME/.bun"
        - export PATH="$BUN_INSTALL/bin:$PATH"
        - bun --version
        # Install dependencies
        - bun install --frozen-lockfile
      script:
        - bun run check

    - stage: lint
      name: "Prettier Format Check"
      install:
        - curl -fsSL https://bun.sh/install | bash
        - export BUN_INSTALL="$HOME/.bun"
        - export PATH="$BUN_INSTALL/bin:$PATH"
        - bun install --frozen-lockfile
      script:
        - bun run f:check

    # ============================================
    # Stage: Docker Build & Test (Post-build)
    # ============================================
    - stage: docker
      name: "Docker Build & Health Check"
      services:
        - docker
      before_install:
        # Install Doppler CLI for secrets
        - curl -sLf --retry 3 --tlsv1.2 --proto "=https" 'https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key' | sudo gpg --dearmor -o /usr/share/keyrings/doppler-archive-keyring.gpg
        - echo "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main" | sudo tee /etc/apt/sources.list.d/doppler-cli.list
        - sudo apt-get update && sudo apt-get install -y doppler
      script:
        # Build the Docker image
        - docker build -t amina:test .

        # Create a test .env file from Doppler (for container testing)
        # Uses amina project with dev config for full runtime secrets
        - |
          if [ -n "$DOPPLER_TOKEN" ]; then
            doppler secrets download -p amina -c dev --no-file --format env > .env.test
            echo "Doppler secrets loaded from amina/dev"
          else
            echo "DOPPLER_TOKEN not set, using minimal test env"
            echo "NODE_ENV=test" > .env.test
            echo "HEALTH_PORT=3000" >> .env.test
          fi

        # Run the container in background
        - docker run -d --name amina-test --env-file .env.test -p 3000:3000 amina:test

        # Wait for container to be healthy
        - |
          echo "Waiting for container to start..."
          for i in {1..30}; do
            if docker exec amina-test wget --no-verbose --tries=1 --spider http://localhost:3000/health 2>/dev/null; then
              echo "Container is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done
          echo "Container health check failed"
          docker logs amina-test
          exit 1
      after_script:
        - docker stop amina-test || true
        - docker rm amina-test || true
        - rm -f .env.test

# Notifications (optional)
notifications:
  email:
    on_success: never
    on_failure: change
