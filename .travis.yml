# Travis CI Configuration for Amina Discord Bot
# Uses Doppler CLI for secrets management
# Free for students: https://education.travis-ci.com/

language: node_js
node_js:
  - 25.6.0
os: linux
dist: jammy

# Cache dependencies
cache:
  directories:
    - ~/.bun/install/cache
    - node_modules

# Environment variables (DOPPLER_TOKEN should be set in Travis CI settings)
env:
  global:
    - DOPPLER_PROJECT=amina
    - DOPPLER_CONFIG=dev

stages:
  - name: lint
    if: (type = pull_request AND branch = main) OR (type = push AND branch = main)
  - name: docker
    if: (type = pull_request AND branch = main) OR (type = push AND branch = main)

jobs:
  include:
    # ============================================
    # Stage: Lint & Runtime Test (Pre-build)
    # ============================================
    - stage: lint
      name: "Code Quality & Native Runtime Test"
      before_install:
        # Install Doppler CLI for secrets
        - curl -sLf --retry 3 --tlsv1.2 --proto "=https" 'https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key' | sudo gpg --dearmor -o /usr/share/keyrings/doppler-archive-keyring.gpg
        - echo "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main" | sudo tee /etc/apt/sources.list.d/doppler-cli.list
        - sudo apt-get update && sudo apt-get install -y doppler
      install:
        # Install Bun
        - curl -fsSL https://bun.sh/install | bash
        - export BUN_INSTALL="$HOME/.bun"
        - export PATH="$BUN_INSTALL/bin:$PATH"
        # Install dependencies
        - bun install --frozen-lockfile --ignore-scripts

      script:
        # 1. Run linting and type checks
        - bun run check

        # 2. Create .env file from Doppler for native runtime test
        - |
          if [ -n "$DOPPLER_TOKEN" ]; then
            doppler secrets download -p amina -c dev --no-file --format env > .env
            echo "Doppler secrets loaded for native runtime test"
          else
            echo "DOPPLER_TOKEN not set, using minimal test env"
            echo "NODE_ENV=test" > .env
            echo "HEALTH_PORT=3000" >> .env
          fi

        # 3. Start app in background and test production readiness
        - |
          echo "Starting native Bun runtime test..."
          mkdir -p logs
          bun . > logs/app.log 2>&1 &
          APP_PID=$!
          echo "App started with PID $APP_PID"

          # Wait for health endpoint
          echo "Waiting for app to be healthy..."
          for i in {1..30}; do
            if curl -f -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "✓ Native app is healthy!"
              kill $APP_PID 2>/dev/null || true
              wait $APP_PID 2>/dev/null || true
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done

          # Health check failed - show logs and exit
          echo "✗ Native health check failed"
          echo "=== App logs ==="
          cat logs/app.log || echo "No logs available"
          kill $APP_PID 2>/dev/null || true
          wait $APP_PID 2>/dev/null || true
          exit 1

      after_script:
        # Cleanup: Ensure process is killed and secrets are removed
        - pkill -f "bun ." || true
        - rm -f .env
        - rm -rf logs

    # ============================================
    # Stage: Docker Build & Test (Post-build)
    # ============================================
    - stage: docker
      name: "Docker Compose Build & Health Check"
      services:
        - docker
      before_install:
        # Install Doppler CLI for secrets
        - curl -sLf --retry 3 --tlsv1.2 --proto "=https" 'https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key' | sudo gpg --dearmor -o /usr/share/keyrings/doppler-archive-keyring.gpg
        - echo "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main" | sudo tee /etc/apt/sources.list.d/doppler-cli.list
        - sudo apt-get update && sudo apt-get install -y doppler
      script:
        # Create .env file from Doppler for docker compose
        - |
          if [ -n "$DOPPLER_TOKEN" ]; then
            doppler secrets download -p amina -c dev --no-file --format env > .env
            echo "Doppler secrets loaded from amina/dev"
          else
            echo "DOPPLER_TOKEN not set, using minimal test env"
            echo "NODE_ENV=test" > .env
            echo "HEALTH_PORT=3000" >> .env
          fi

        # Build and start services with docker compose
        - docker compose build amina
        - docker compose up -d amina

        # Wait for amina container to be healthy
        - |
          echo "Waiting for amina container to start..."
          for i in {1..30}; do
            if docker compose exec -T amina wget --no-verbose --tries=1 --spider http://localhost:3000/health 2>/dev/null; then
              echo "Amina container is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 2
          done
          echo "Container health check failed"
          docker compose logs amina
          exit 1
      after_script:
        - docker compose down -v || true
        - rm -f .env

# Notifications (optional)
notifications:
  email:
    on_success: never
    on_failure: change
